BACKSPACE=8;ENTER=13;PAUSE_BREAK=19;DEL=46;SPACEBAR=32;LEFT_ARROW=37;UP_ARROW=38;RIGHT_ARROW=39;DOWN_ARROW=40;ESC=27;CAPS=20;TAB=9;PGUP=33;PGDN=34;Z_KEY=90;X_KEY=88;C_KEY=67;V_KEY=86;B_KEY=66;SEARCH_THROTTLE_TIME=200;PERPAGE_MIN=3;PERPAGE_MAX=10;SEARCH_MAX=1E3;
var tokenError=false,queue=[],videos=[],perPage=PERPAGE_MIN,perDisplayed=0,searchTotal=SEARCH_MAX,startIndex=1,searchItemHeight=105,oldSearch="",oldFilter="",throttle=false,filterThrottle=false,suggested="",curRequest=null,lastFocused,windowFocused=true,itemFocused=false,token,leaving=false;function notifyOpener(){if(self.opener&&!self.opener.popupWin)self.opener.popupWin=self}setInterval(notifyOpener,200);function setHash(a){a=$.trim(a);window.location.replace("#"+encodeURI(a))}
function sendQueue(){self.opener&&self.opener.recvQueue(queue)}function recvQueue(a){queue=a;updateManagerDisplay()}function calculateDims(){searchItemHeight=$("#results .resultItem:first").outerHeight(true);calculatePerPage()}
function run(){String.prototype.ltrim=function(){return this.replace(/^\s+/,"")};var a=$.param.fragment(),b=$.deparam.fragment(a),c={select:onTabSelect,cookie:{expires:3600}};if(b.tab)c.selected=parseInt(b.tab);$("#tabs").tabs(c);a.length>0&&setHash("");$("#shinedays").load(calculateDims);$("#shinedays").attr("src","shinedays.jpg");if(b.access_token&&b.expires_in){a=b.access_token;c=parseInt(b.expires_in);a.length>0&&!isNaN(c)&&$.cookie("token-ytkaraoke",a,{expires:c,path:"/"})}else if(b.error)tokenError=
true;updateLoginout();onTabSelectIndex($("#tabs").tabs("option","selected"));$("#searchBox").val(b.q||"");$("#searchBox").focus(onSearchFocus);$("#searchBox").trigger("focus");$("#searchBox").blur(onSearchBlur);setAutoFocus($("#searchBox"));throttledSearch();$("#managerFilter").val("");$("#managerFilter").keyup(onFilterKeyUp);$("#managerFilter").focus(onFilterFocus);$("#managerFilter").blur(onFilterBlur);$("#managerFilter").keydown(onFilterKeyDown);$("#searchBox").keyup(onSearchKeyUp);$("#searchBox").input(onSearchInput);
$("#searchBox").keydown(onSearchKeyDown);$("#suggestBox").focus(onSuggestFocus);$("#suggestBox").val("");$("#searchText").css("font-family",$("#searchBox").css("font-family"));$("#searchText").css("font-size",$("#searchBox").css("font-size"));$("#suggestText").css("font-family",$("#searchBox").css("font-family"));$("#suggestText").css("font-size",$("#searchBox").css("font-size"));$("#searchForm").submit(function(){return false});$("#playlistForm").submit(function(){getPlaylists();return false});setInterval(lastFocus,
300);$(window).blur(onWindowBlur);$(window).focus(onWindowFocus);$(window).resize(onWindowResize);$(document.documentElement).keydown(onKeyDown);$(document.documentElement).keyup(onKeyUp);$(window).unload(function(){!leaving&&self.opener&&self.opener.showSearch()});$(document).mousewheel(onMouseWheel);$.browser.msie&&$(window).error(function(){return true});self.opener&&self.opener.sendQueue()}function onMouseWheel(a,b){if(b>0)searchControl(PGUP);else b<0&&searchControl(PGDN)}
function onFilterKeyUp(a){filterThrottle||throttledFilter();filterTrapKey(a.keyCode)&&a.stopPropagation()}function onFilterFocus(){lastFocused=$("#managerFilter");itemFocused=true}function onFilterBlur(){itemFocused=false}function onFilterKeyDown(a){filterTrapKey(a.keyCode)&&a.stopPropagation()}function filterTrapKey(a){return $("#managerFilter").val()!=""&&a==BACKSPACE}
function throttledFilter(){filterThrottle=false;var a=$("#managerFilter").val().toLowerCase();if(oldFilter!=a){filterThrottle=true;oldFilter=a;updateManagerDisplay();setTimeout(function(){throttledFilter(false)},SEARCH_THROTTLE_TIME)}}function setAutoFocus(a){if(lastFocused!=a){lastFocused=a;itemFocused=false}}function lastFocus(){if(windowFocused&&lastFocused&&!itemFocused){lastFocused.focus();itemFocused=true}}
function updateLoginout(){if(!$.cookie("token-ytkaraoke")||tokenError){$("#loginoutLink").attr("href","javascript:login()");$("#loginoutLink").text("Login")}else{$("#loginoutLink").attr("href","javascript:logout()");$("#loginoutLink").text("")}}function logout(){$.cookie("token-ytkaraoke",null,{path:"/"});$("#tabs").tabs("option","selected")==2&&$("#tabs").tabs("select","#tab-search");updateLoginout()}
function login(a){if(!a)if(token=$.cookie("token-ytkaraoke")){updateLoginout();return token}if(tokenError)return false;a="https://accounts.google.com/o/oauth2/auth?client_id=322058828862.apps.googleusercontent.com&redirect_uri="+encodeURIComponent(window.location.protocol+"//"+window.location.hostname+window.location.pathname)+"&scope="+encodeURIComponent("http://gdata.youtube.com")+"&response_type=token&state=tab=";leaving=true;$("#authForm").attr("action",a);$("#authForm").submit();$("#control").append("submitted!");
return false}var playlists=[];function traverse(a,b){for(i in a){console.log(i+": "+a[i]);typeof a[i]=="object"&&traverse(a[i],b)}}function queueVideos(a,b){if(self.opener){for(var c=[],d=0;d<a.length;d++)c.push(a[d].video);self.opener.queueVideos(c);self.opener.barMsg("Queued playlist: "+b)}}function queuePlaylist(a){getPlaylist(playlists[a].id,function(b){queueVideos(b,playlists[a].title)})}
function getPlaylist(a,b){login()&&$.ajax({type:"GET",url:"http://gdata.youtube.com/feeds/api/playlists/"+a+"?v=2&format=5&alt=jsonc&oauth_token="+token,dataType:"jsonp",success:function(c){c.data.items&&typeof b=="function"&&b(c.data.items)},error:function(){login(true)}})}
function getPlaylists(){if(login())$.ajax({type:"GET",url:"http://gdata.youtube.com/feeds/api/users/default/playlists?v=2&alt=jsonc&oauth_token="+token,dataType:"jsonp",success:function(b){$("#control").append("got");playlists=b.data.items?b.data.items:[];b=$("#playlistResults").empty();$("#playlistsTemplate").tmpl({playlists:playlists}).appendTo(b)},error:function(b,c){$("#control").append("error: "+c);login(true)}});else{$("#control").append("empty");playlists=[];var a=$("#playlistResults").empty();
$("#playlistsTemplate").tmpl({playlists:playlists}).appendTo(a)}}function onTabSelect(a,b){onTabSelectIndex(b.index)}function onTabSelectIndex(a){if(a==0)setAutoFocus($("#searchBox"));else if(a==1)setAutoFocus($("#managerFilter"));else a==2&&getPlaylists()}function onSearchFocus(){lastFocused=$("#searchBox");itemFocused=true}function onSearchBlur(){itemFocused=false}function onWindowFocus(){windowFocused=true}function onWindowBlur(){windowFocused=false}
function perPageChanged(a){a>videos.length?searchControl(ENTER):updateSearchResults(videos)}function calculatePerPage(){var a=Math.floor(($("#tab-search").height()-$("#searchForm").height())/searchItemHeight+0.3);a=Math.min(a,PERPAGE_MAX);a=Math.max(a,PERPAGE_MIN);if(perPage!=a){perPage=a;perPageChanged(a)}}function onWindowResize(){calculatePerPage()}
function addCommas(a){a+="";x=a.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";for(a=/(\d+)(\d{3})/;a.test(x1);)x1=x1.replace(a,"$1,$2");return x1+x2}
function onKeyDown(a){var b=$.client.os=="Mac"?a.ctrlKey:a.altKey;if(b&&(a.keyCode==V_KEY||a.keyCode==RIGHT_ARROW)){nextVideo();return false}else if(b&&(a.keyCode==X_KEY||a.keyCode==LEFT_ARROW)){prevVideo();return false}else if(b&&a.keyCode==C_KEY||($.client.os=="Mac"?a.ctrlKey:a.shiftKey)&&a.keyCode==SPACEBAR||a.keyCode==PAUSE_BREAK){playPauseVideo();return false}else if(a.keyCode==PGUP||a.keyCode==PGDN){searchControl(a.keyCode);return false}return a.keyCode!=BACKSPACE}
function onKeyUp(a){return a.keyCode!=BACKSPACE}function searchTrapKey(a){return a==BACKSPACE||a==PGUP||a==PGDN}function onSuggestFocus(){lastFocused=$("#searchBox");$("#searchBox").trigger("focus");var a=$("#searchBox").val();$("#searchBox").setSelection(a.length,a.length)}function setSuggested(a){suggested=a;$("#suggestBox").val(suggested)}function onSearchKeyUp(a){searchTrapKey(a.keyCode)&&a.stopPropagation()}
function onSearchInput(){var a=$("#searchBox").val();$("#searchText").html(a);if(suggested.indexOf(a)!=0){setSuggested("");startIndex=1;searchTotal=SEARCH_MAX}searchControl(0)}
function searchControl(a){var b=$("#searchBox").val().ltrim();if(a==0){forceSearch=false;suggestEnabled=true}else if(b!="")if(a==ENTER){forceSearch=true;suggestEnabled=false}else if(a==PGUP){a=startIndex;if(startIndex>searchTotal)a=Math.floor(searchTotal/perPage)*perPage+1;else{a=startIndex-perPage;a=Math.max(1,a)}if(a!=startIndex){forceSearch=true;startIndex=a}}else if(a==PGDN){a=startIndex;if(startIndex+perPage<=searchTotal)a=startIndex+perPage;else if(startIndex>searchTotal)a=Math.floor(searchTotal/
perPage)*perPage+1;if(a!=startIndex){forceSearch=true;startIndex=a}}throttle||throttledSearch()}
function onSearchKeyDown(a){if(a.keyCode==ENTER){setSuggested("");searchControl(ENTER)}else if(a.keyCode==PGUP||a.keyCode==PGDN)searchControl(a.keyCode);var b=$("#searchBox").getSelection(),c=$("#searchBox").val();if(a.keyCode==RIGHT_ARROW)if(c.length>0&&suggested.length>0)if(b.start>=c.length){$("#searchBox").val(suggested);$("#searchBox").setSelection(suggested.length,suggested.length);$("#searchText").html(suggested)}searchTrapKey(a.keyCode)&&a.stopPropagation()}
var forceSearch=false,suggestEnabled=true;function throttledSearch(){throttle=false;var a=$("#searchBox").val();if(oldSearch!=a||forceSearch){throttle=true;oldSearch=a;suggestEnabled?suggest(a):search(a,startIndex,perPage);forceSearch=false;setTimeout(function(){throttledSearch(false)},SEARCH_THROTTLE_TIME)}}
function isCharKeyPress(a){if(typeof a.which=="undefined")return true;else if(typeof a.which=="number"&&a.which>0){if(a.ctrlKey||a.metaKey||a.altKey)return false;return a.keyCode!=ENTER}return false}function onSearchKeyPress(a){var b=$("#searchBox").getSelection(),c=$("#searchBox").val();b.start<c.length&&isCharKeyPress(a)&&setSuggested("")}function setSuggested(a){suggested=a;$("#suggestBox").val(suggested)}
function suggest(a){var b="http://suggestqueries.google.com/complete/search?hl=en&ds=yt&json=t&q="+encodeURIComponent(a);if(a.length>0){curRequest&&curRequest.abort();curRequest=$.ajax({type:"GET",url:b,dataType:"jsonp",success:function(c){curRequest=null;c=c[1];var d=a.ltrim();if(c&&c.length&&c[0].indexOf(d)==0){d=a.indexOf(d);newSuggested=a.substring(0,d)+c[0];if(newSuggested!=suggested){startIndex=1;searchTotal=SEARCH_MAX;setSuggested(newSuggested)}search(suggested,startIndex,perPage)}else{startIndex=
1;searchTotal=SEARCH_MAX;setSuggested("");search(a,1,perPage)}}})}else{startIndex=1;searchTotal=SEARCH_MAX;setSuggested("");search("",1,perPage)}}
function search(a,b,c){if(typeof b=="undefined")b=1;if(typeof c=="undefined")c=perPage||5;var d=a.match(/&t=(.+?)(?=&|$)/);offset=0;if(d){a=a.substring(0,d.index)+a.substring(d.index+d[0].length);offstr=d[1];if(d=offstr.match(/(\d+)m/))offset=parseInt(d[1])*60;if(d=offstr.match(/(\d+)(s|(?![m\d]))/))offset+=parseInt(d[1])}b="http://gdata.youtube.com/feeds/api/videos?q="+encodeURIComponent(a)+"&format=5&v=2&alt=jsonc&start-index="+b+"&max-results="+c;if(a.length>0){curRequest&&curRequest.abort();curRequest=
$.ajax({type:"GET",url:b,dataType:"jsonp",success:function(e){curRequest=null;if(e.data.items){videos=e.data.items;for(var f=0;f<videos.length;f++)videos[f].offset=offset}else videos=[];searchTotal=Math.min(e.data.totalItems||SEARCH_MAX,SEARCH_MAX);if(!e.data.items&&searchTotal>1&&startIndex>1){if(startIndex>searchTotal)startIndex=Math.floor(searchTotal/perPage)*perPage+1;else{startIndex-=perPage;startIndex=Math.max(1,startIndex)}search(a,startIndex,perPage)}updateSearchResults(videos)}})}else{videos=
[];updateSearchResults(videos)}}function updateSearchResults(){var a=$("#resultsWrapper").empty();$("#searchTemplate").tmpl({results:videos,count:perPage}).appendTo(a);perDisplayed=Math.min(videos.length,perPage);$("#results > .resultItem").hover(onSearchItemMouseEnter,onSearchItemMouseLeave)}
function updateManagerDisplay(){if(queue.length>0){$("#managerFilter").show();for(var a=$("#managerFilter").val().toLowerCase(),b=$("<ul/>"),c=0;c<queue.length;c++)if(a==""||queue[c].title.toLowerCase().indexOf(a)>-1)$("#managerTemplate").tmpl({index:c,item:queue[c]}).appendTo(b);$("#managerQueue").empty().append(b);if(a==""){b.sortable("enable");b.sortable({update:queueSort,helper:"clone"})}}else{$("#managerFilter").hide();$("#managerQueue").html("You have no items in the queue")}}
function queueSort(){var a=$(this).children();if(a.length>0){for(var b=[],c=0;c<a.length;c++){var d=$(a[c]).attr("id");d=parseInt(d.substring(d.indexOf("-")+1));b.push(d)}if(self.opener){self.opener.queueReorder(b);updateManagerDisplay()}}}function onPlayerStateChange(a){if(a==1||a==3)$("#controlPlayPause").attr("src","pause-22.png");else a!=-1&&$("#controlPlayPause").attr("src","play-22.png")}
function onSearchItemMouseEnter(){$(this).find(".watchnowLink,.enqueueImg").css("display","inline-block")}function onSearchItemMouseLeave(){$(this).find(".watchnowLink,.enqueueImg").hide()}function queueRemove(a){self.opener&&self.opener.queueRemove(a)}function watchSearchNow(a){watchVideoNow(videos[a])}function watchVideoNow(a){self.opener&&self.opener.watchVideoNow(a)}function watchNow(a){self.opener&&self.opener.watchNow(a)}
function queueSearchVideo(a){self.opener&&self.opener.queueVideo(videos[a])}function nextVideo(){self.opener&&self.opener.forceNextVideo()}function prevVideo(){self.opener&&self.opener.prevVideo()}function playVideo(){self.opener&&self.opener.playVideo()}function pauseVideo(){self.opener&&self.opener.pauseVideo()}function stopVideo(){self.opener&&self.opener.stopVideo()}function playPauseVideo(){self.opener&&self.opener.playPauseVideo()}
function addCommas(a){a+="";x=a.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";for(a=/(\d+)(\d{3})/;a.test(x1);)x1=x1.replace(a,"$1,$2");return x1+x2}String.prototype.truncate=function(a,b){if(typeof b=="undefined")b="&hellip;";var c=RegExp("^.{0,"+a+"}[S]*").exec(this),d=c[0].length;c=c[0].replace(/\s$/,"");if(d<this.length)c+=b;return c};String.prototype.encodeHTML=function(){return this.split("<").join("&lt;").split(">").join("&gt;").split('"').join("&#34;").split("'").join("&#39;")};
$.browser.msie?google.setOnLoadCallback(run):$(document).ready(run);